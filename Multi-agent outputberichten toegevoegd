import streamlit as st
import pandas as pd
from io import StringIO

st.set_page_config(page_title="Fiscale Multi-Agent AI", layout="centered")
st.title("ü§ñ Fiscale Jaarrekening AI met Multi-Agent Simulatie")
st.write("Upload je boekhoudbestand (CSV) en zie hoe onze AI-agents samenwerken aan een fiscale jaarrekening.")

uploaded_file = st.file_uploader("üìé Upload je CSV-bestand", type=["csv"])

if uploaded_file is not None:
    try:
        st.markdown("**üìú Inlees-agent:** 'Ik controleer het bestand op structuur en kolommen‚Ä¶'")
        df = pd.read_csv(uploaded_file)

        if not {"Grootboekrekening", "Bedrag (EUR)"}.issubset(df.columns):
            st.error("CSV moet de kolommen 'Grootboekrekening' en 'Bedrag (EUR)' bevatten.")
        else:
            st.markdown("**üß† Analyse-agent:** 'Ik analyseer de aard van de kostenposten‚Ä¶'")

            def bepaal_posttype(omschrijving):
                omschrijving = omschrijving.lower()
                if "representatie" in omschrijving or "relatiegeschenk" in omschrijving:
                    return "Representatiekosten"
                elif "auto" in omschrijving or "lease" in omschrijving:
                    return "Autokosten"
                elif "huur" in omschrijving:
                    return "Huisvestingskosten"
                else:
                    return "Overige kosten"

            df["Herkenning"] = df["Grootboekrekening"].apply(bepaal_posttype)

            analyse_feedback = ""
            for i, rij in df.iterrows():
                analyse_feedback += f"- Rij {i+1}: '{rij['Grootboekrekening']}' geclassificeerd als **{rij['Herkenning']}**\n"
            st.markdown(f"**üß† Analyse-agent:**\n{analyse_feedback}")

            st.markdown("**‚öñÔ∏è Correctie-agent:** 'Ik pas de fiscale correcties toe en geef uitleg‚Ä¶'")

            toelichtingen = []
            correctie_feedback = ""

            def corrigeer(rij):
                bedrag = rij["Bedrag (EUR)"]
                soort = rij["Herkenning"]
                if soort == "Representatiekosten":
                    toelichting = "80% aftrekbaar volgens fiscale regels"
                    fiscaal = bedrag * 0.8
                elif soort == "Autokosten":
                    toelichting = "90% aftrekbaar voor zakelijke autokosten"
                    fiscaal = bedrag * 0.9
                else:
                    toelichting = "Volledig aftrekbaar"
                    fiscaal = bedrag
                correctie_feedback_line = f"- Rij '{rij['Grootboekrekening']}': {toelichting}"
                toelichtingen.append(toelichting)
                return fiscaal, correctie_feedback_line

            resultaten = df.apply(lambda rij: corrigeer(rij), axis=1)
            df["Fiscaal aftrekbaar (EUR)"] = [r[0] for r in resultaten]
            correctie_feedback = "\n".join([r[1] for r in resultaten])
            df["Toelichting"] = toelichtingen
            df["Correctie (EUR)"] = df["Bedrag (EUR)"] - df["Fiscaal aftrekbaar (EUR)"]

            st.markdown(f"**‚öñÔ∏è Correctie-agent:**\n{correctie_feedback}")

            st.success("‚úÖ Fiscale correcties voltooid!")
            st.dataframe(df)

            output = StringIO()
            df.to_csv(output, index=False)
            st.download_button(
                label="üìÖ Download fiscale jaarrekening (CSV)",
                data=output.getvalue(),
                file_name="fiscale_jaarrekening_agents.csv",
                mime="text/csv"
            )

    except Exception as e:
        st.error(f"Fout bij verwerken van bestand: {e}")
else:
    st.info("Wacht op bestand‚Ä¶ De agents staan klaar om te starten.")
